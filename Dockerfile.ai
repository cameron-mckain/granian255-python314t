FROM containers.github.projectunity.io/mckain/granian-python313:latest

# Install system dependencies for dlib, opencv, and other AI packages
RUN yum install -y \
    cmake \
    gcc-c++ \
    openblas-devel \
    lapack-devel \
    gtk3-devel \
    libX11-devel \
    && yum clean all

# Copy pre-downloaded wheels (managed with Git LFS)
COPY wheels/ai/*.whl /tmp/ai-wheels/

# Install PyTorch CPU from local wheel first (with dependencies)
RUN python3.13 -m pip install /tmp/ai-wheels/torch-*.whl

# Install AI/ML packages
RUN python3.13 -m pip install \
    opencv-python \
    spacy \
    spacy-llm \
    azure-cognitiveservices-vision-computervision \
    google-cloud-storage \
    dlib \
    pytumblr

# Install spaCy models from local wheels (after spacy is installed)
RUN python3.13 -m pip install \
    /tmp/ai-wheels/en_core_web_sm-*.whl \
    /tmp/ai-wheels/en_core_web_md-*.whl \
    /tmp/ai-wheels/en_core_web_lg-*.whl \
    /tmp/ai-wheels/en_core_web_trf-*.whl

# Clean up wheels
RUN rm -rf /tmp/ai-wheels

# Expose port 8000
EXPOSE 8000

# Default command
CMD ["python3.13", "--version"]
